{% extends 'base.html' %}
{% block body %}

{% include 'buzzer_navbar.html' %}
<div class="header-box-outer jumbotron">
  <div class="header-box-inner text-center">
    <h3>
      Room Code: <b>{{ room_id }}</b>
      <button id="audio_button" class="btn btn-sm btn-light ml-2 p-1" checked="true">
        <img src="{{ url_for('static',filename='images/audio_on_icon.svg') }}" alt="Audio On Icon"/>
      </button>
    </h3>
  </div>
</div>

<div class="tab-content">
  <div id="buzzer" class="tab-pane fade in active">
    <div class="buzzer-wrapper container-fluid">
      <div class="mb-4">
        <button type="button" id="buzz" class="btn btn-danger btn-block btn-lg">Buzz</button>
      </div>
      <div class="text-center mb-3">
        Quickest buzzes will appear below
      </div>
      <div class="buzz-log">
        <div class="list-group"></div>
      </div>
    </div>
  </div>

  <div id="scoreboard" class="tab-pane fade">
    <div class="container-fluid py-3">
      <div class="table-responsive">
        <table class="table table-striped table-bordered text-center" id="scoreboard_table">
          <thead class="thead-dark text-center">
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>Score</th>
              <th>Correct</th>
              <th>Early Incorrect</th>
              <th>Streak</th>
              <th>Longest</th>
            </tr>
          </thead>
          <tbody>
            <!-- Score rows will be inserted here dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="host" class="tab-pane fade">
    <div class="host-wrapper container-fluid py-3">
      <div class="row">
        <div class="col-md-6 mb-3">
          <button type="button" id="correct" class="btn btn-success btn-block btn-lg"><b>Correct</b></button>
        </div>
        <div class="col-md-6 mb-3">
          <button type="button" id="reset_buzzer" class="btn btn-light btn-block btn-lg">Reset</button>
        </div>
        <div class="col-md-6 mb-3">
          <button type="button" id="standard_incorrect" class="btn btn-warning btn-block btn-lg"><b>Standard Incorrect</b></button>
        </div>
        <div class="col-md-6 mb-3">
          <button type="button" id="early_incorrect" class="btn btn-danger btn-block btn-lg"><b>Early Incorrect</b></button>
        </div>
      </div>
      <h4 class="mt-3">Current Buzz Log</h4>
      <div class="buzz-log">
        <div class="list-group"></div>
      </div>
    </div>
  </div>

  <div id="settings" class="tab-pane fade">
    <div class="settings-wrapper container-fluid py-3">
      <h2>Configure Room Settings</h2>
      <form method="post">
        <input type="hidden" id="ParticipantNameInput" name="participant_name" value="{{ participant_name }}">
        <input type="hidden" id="RoomIDInput" name="room_id" value="{{ room_id }}">

        <div class="form-group">
          <label for="correctPointsInput">Correct Points</label>
          <input type="number" class="form-control" id="correctPointsInput" name="correct_points">
          <small class="form-text text-muted">Points for a correct answer</small>
        </div>
        <div class="form-group">
          <label for="earlyIncorrectPointsInput">Incorrect Points</label>
          <input type="number" class="form-control" id="earlyIncorrectPointsInput" name="early_incorrect_points">
          <small class="form-text text-muted">Points to subtract for an early incorrect answer</small>
        </div>
        <div class="form-group">
          <label for="oneBuzzPerQuestionInput">One Buzz Per Question</label>
          {{ form.one_buzz_per_question }}
          <small class="form-text text-muted">Whether a player should be locked out after guessing</small>
        </div>
        <div class="form-group">
          <label for="TimeEvaluationMethodInput">Buzz Time Evaluation Method</label>
          {{ form.time_evaluation_method }}
          <small class="form-text text-muted">The method that will be used to determine who has buzzed the fastest</small>
        </div>
        <div class="form-group">
          <label for="sortLatencyInput">Sort Latency</label>
          <input type="number" class="form-control" id="sortLatencyInput" name="sort_latency">
          <small class="form-text text-muted">The slowest player's connection speed in milliseconds, allows the server to sort client-side connection speeds</small>
        </div>

        <button class="btn btn-primary" name="submit">Update Settings</button>
      </form>

      <hr>
      <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#resetRoomScoresModal">
        Reset Room Scores
      </button>

      <div class="modal fade" id="resetRoomScoresModal" tabindex="-1" role="dialog" aria-labelledby="resetRoomScoresModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resetRoomScoresModalLabel">Are you sure you want to reset the room scores?</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" data-dismiss="modal" id="reset_room_scores">Reset Room Scores</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
    const ROOM_ID = '{{ room_id }}';
    const PARTICIPANT_NAME = '{{ participant_name }}';
    const AUDIO_URL = '{{ url_for('static',filename='audio/soft_beep.mp3') }}';
    const AUDIO_ON_ICON = '{{ url_for('static',filename='images/audio_on_icon.svg') }}';
    const AUDIO_OFF_ICON = '{{ url_for('static',filename='images/audio_off_icon.svg') }}';
    let buzzes = [];
    let lockedOutPlayers = [];
    const audio = new Audio(AUDIO_URL);
    audio.muted = false;
    const SOCKET_BASE_URL = 'http://' + document.domain + ':8000';
    const socket = io(SOCKET_BASE_URL, {
        transports: ['websocket', 'polling'],
        forceNew: true,
        query: { room_id: ROOM_ID }
    });

    function nameInCurrentBuzzes(name, currentBuzzes) {
        return currentBuzzes.some(buzz => buzz.name === name);
    }

    function formatTimeDifference(timeDiffSeconds) {
        if (timeDiffSeconds >= 5) {
            return Math.floor(timeDiffSeconds) + ' secs';
        }
        return Math.round(timeDiffSeconds * 1000) + 'ms';
    }

    function updateBuzzLog(currentBuzzes) {
      if (currentBuzzes.length === 0) {
          $(".buzz-log").html('<div class="list-group"></div>');
          return;
      }
      const firstBuzzTime = currentBuzzes[0].time;
      let buzzLogHtml = '<div class="list-group">';
      currentBuzzes.forEach((buzz, index) => {
        if (index === 0) {
          buzzLogHtml += `<button type="button" class="list-group-item list-group-item-success d-flex justify-content-between align-items-center"><b>${buzz.name}</b></button>`;
        } else {
          const secondsTimeDiff = buzz.time - firstBuzzTime;
          const timeDiffString = formatTimeDifference(secondsTimeDiff);
          buzzLogHtml += `<button type="button" class="list-group-item d-flex justify-content-between align-items-center">${buzz.name}<span class="badge badge-primary badge-pill">+${timeDiffString}</span></button>`;
        }
      });
      buzzLogHtml += '</div>';
      $(".buzz-log").html(buzzLogHtml);
    }

    function updateScoreboard(playerScores) {
      const tbody = $("#scoreboard_table tbody");
      tbody.empty();
      playerScores.forEach((player, index) => {
        tbody.append(`
          <tr>
            <td>${index + 1}</td>
            <td>${player.name}</td>
            <td>${player.score}</td>
            <td>${player.correct_answers}</td>
            <td>${player.early_incorrect_answers}</td>
            <td>${player.current_streak}</td>
            <td>${player.longest_streak}</td>
          </tr>
        `);
      });
    }

    function updateBuzzerColour(currentBuzzes, lockedOutPlayers) {
        const $buzzButton = $("#buzz");
        $buzzButton.removeClass("btn-success btn-warning btn-light btn-danger");
        if (currentBuzzes.length > 0 && currentBuzzes[0].name === PARTICIPANT_NAME) {
            $buzzButton.addClass("btn-success").html("<b>ANSWER NOW</b>");
        } else if (currentBuzzes.length > 0 && nameInCurrentBuzzes(PARTICIPANT_NAME, currentBuzzes)) {
            $buzzButton.addClass("btn-warning").html("<b>Someone beat you to it...</b><br>Please wait");
        } else if (lockedOutPlayers.includes(PARTICIPANT_NAME)) {
            $buzzButton.addClass("btn-light").html("<b>You have already buzzed this question</b><br>If this is not expected, ask for a reset");
        } else {
            $buzzButton.addClass("btn-danger").html("Buzz");
        }
    }

    function updateSettings(config) {
      $("#correctPointsInput").val(config.correct_points);
      $("#earlyIncorrectPointsInput").val(config.early_incorrect_points);
      $("#timeEvaluationMethodInput").val(config.time_evaluation_method);
      $("#oneBuzzPerQuestionInput").val(config.one_buzz_per_question.toString());
      $("#sortLatencyInput").val(config.sort_latency);
    }

    function alertServerMaintenance(should) {
      const snackbar = document.getElementById("snackbar");
      if (should) {
        snackbar.className = "showSnackbar";
        setTimeout(() => { snackbar.className = snackbar.className.replace("showSnackbar", ""); }, 30000);
      }
    }

    socket.on('connect', function() {
        console.log("Socket successfully connected to:", socket.io.uri);
        socket.emit('join_room', {"room_id": ROOM_ID, "participant_name": PARTICIPANT_NAME});
    });

    socket.on('disconnect', function() { console.log("Socket disconnected."); });

    socket.on('server_room_update', function(payload) {
      const data = JSON.parse(payload);
      buzzes = data.current_buzzes;
      lockedOutPlayers = data.locked_out_players;
      if (data.play_audio && !audio.muted) { audio.play(); }
      updateBuzzLog(buzzes);
      updateScoreboard(data.scoreboard);
      updateBuzzerColour(data.current_buzzes, data.locked_out_players);
      updateSettings(data.config);
      alertServerMaintenance(data.server_maintenance_alert);
    });

    function ping() {
      const time = (new Date).getTime();
      socket.emit("my_ping", {"participant_name": PARTICIPANT_NAME, "room_id": ROOM_ID, "client_side_time": time});
    }

    $("#buzz").on("click", function () {
      const time = (new Date).getTime();
      if (nameInCurrentBuzzes(PARTICIPANT_NAME, buzzes) || lockedOutPlayers.includes(PARTICIPANT_NAME)) { return; }
      socket.emit("buzz", {"participant_name": PARTICIPANT_NAME, "room_id": ROOM_ID, "buzz_time": time});
    });

    const hostEvents = {'#correct': 'correct', '#standard_incorrect': 'standard_incorrect', '#early_incorrect': 'early_incorrect', '#reset_buzzer': 'reset_buzzer', '#reset_room_scores': 'reset_room_scores'};
    for (const [selector, eventName] of Object.entries(hostEvents)) {
        $(selector).on("click", function () {
            socket.emit(eventName, {"participant_name": PARTICIPANT_NAME, "room_id": ROOM_ID});
        });
    }

    $("#audio_button").on("click", function () {
        audio.muted = !audio.muted;
        this.innerHTML = audio.muted ? `<img src="${AUDIO_OFF_ICON}" alt="Audio Off Icon"/>` : `<img src="${AUDIO_ON_ICON}" alt="Audio On Icon"/>`;
    });
    $("#collapsableNavbarComponents").on("mouseup", function() { $(this).removeClass("in"); });

    ping();
    window.setInterval(ping, 20000);
});
</script>
{% endblock %}
